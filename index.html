<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <title>–†–ê–°–°–ö–†–ê–°–ö–ê –ü–û –û–¢–í–ï–¢–ê–ú ‚Äî ULTIMATE PRO</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@700&family=Kelly+Slab&family=Lobster&family=Montserrat:wght@900&family=Pacifico&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <style>
        :root { --bg: #050817; --panel: #0b1126; --text: #f1f5f9; --primary: #c084fc; --accent: #38bdf8; }
        body { margin: 0; font-family: 'Comfortaa', cursive; background: var(--bg); color: var(--text); height: 100vh; display: grid; grid-template-columns: 420px 1fr; overflow: hidden; }
        
        .sidebar { background: var(--panel); border-right: 1px solid #1e293b; display: flex; flex-direction: column; overflow-y: auto; padding: 15px; gap: 10px; }
        .header-main { display: flex; align-items: center; gap: 12px; padding-bottom: 10px; border-bottom: 2px solid var(--primary); }
        .header-main h1 { font-size: 16px; margin: 0; color: #fff; text-transform: uppercase; }

        .section { padding: 12px; background: rgba(255,255,255,0.03); border-radius: 10px; border: 1px solid #1e293b; }
        h3 { margin: 0 0 8px; font-size: 10px; text-transform: uppercase; color: var(--accent); letter-spacing: 1px; }
        
        input, textarea, select { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #1e293b; background: #161e3d; color: #fff; margin-bottom: 6px; font-family: inherit; box-sizing: border-box; }
        .btn { width: 100%; padding: 10px; border-radius: 6px; border: 0; cursor: pointer; font-weight: bold; background: var(--primary); color: #000; transition: 0.2s; }
        .btn:hover { transform: translateY(-1px); filter: brightness(1.2); }
        .btn-add { background: #22c55e; color: white; }

        #taskList { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; min-height: 100px; }
        .task-item { padding: 10px; background: #1e293b; border-radius: 8px; border: 2px solid transparent; cursor: pointer; position: relative; font-size: 13px; transition: 0.3s; }
        .task-item.active { border-color: var(--primary); background: #2d3748; box-shadow: 0 0 10px rgba(192, 132, 252, 0.3); }
        .task-item .badge { float: right; background: var(--accent); color: #000; padding: 2px 8px; border-radius: 10px; font-size: 11px; font-weight: bold; }
        .task-item .del { color: #ff4d4d; margin-left: 10px; float: right; cursor: pointer; font-weight: bold; }

        .canvas-area { position: relative; background: radial-gradient(circle, #1e293b 0%, #020617 100%); display: flex; justify-content: center; align-items: center; padding: 20px; }
        .frame { position: relative; border: 3px solid var(--primary); border-radius: 8px; background: white; line-height: 0; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        #mainImg { max-width: 100%; max-height: 70vh; display: block; user-select: none; -webkit-user-drag: none; }
        #mainSvg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair; }

        #preview-box { position: absolute; inset: 0; background: var(--bg); z-index: 1000; display: none; }
        .hint-bar { font-size: 10px; color: #aaa; margin-top: 4px; line-height: 1.4; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="header-main">
        <img src="https://i.ibb.co/q345VSpm/5291888536539828600.jpg" height="35" style="border-radius:50%">
        <h1>ULTIMATE BUILDER PRO</h1>
    </div>

    <div class="section">
        <h3>1. –ö–∞—Ä—Ç–∏–Ω–∫–∞ –∏ –®—Ä–∏—Ñ—Ç</h3>
        <select id="imgPreset" onchange="loadPreset()">
            <option value="">-- –í—ã–±—Ä–∞—Ç—å —à–∞–±–ª–æ–Ω --</option>
            <option value="https://i.ibb.co/jvj9q36b/c8fae767598537c00255e117f9b1199b.jpg">–ú–∏–ª—ã–π –µ–¥–∏–Ω–æ—Ä–æ–≥</option>
            <option value="https://i.ibb.co/GqxzQ5c/2026-02-16-234253.png">–ú—É–¥—Ä–∞—è –°–æ–≤–∞</option>
            <option value="https://i.ibb.co/XZfDj366/2026-02-16-234445.png">–ë–∞—Ä–±–æ—Å–∫–∏–Ω—ã</option>
            <option value="https://i.ibb.co/ch9R8Lbd/Avatar-Jake-Sully-and-Neytiri.png">–ê–≤–∞—Ç–∞—Ä</option>
        </select>
        <input type="file" id="fileInp" accept="image/*">
        <select id="fontFamily">
            <option value="'Comfortaa'">–®—Ä–∏—Ñ—Ç: Comfortaa</option>
            <option value="'Kelly Slab'">–®—Ä–∏—Ñ—Ç: Kelly Slab</option>
            <option value="'Lobster'">–®—Ä–∏—Ñ—Ç: Lobster</option>
            <option value="'Montserrat'">–®—Ä–∏—Ñ—Ç: Montserrat</option>
            <option value="'Pacifico'">–®—Ä–∏—Ñ—Ç: Pacifico</option>
        </select>
        <div style="display:flex; gap:5px;">
            <div style="flex:1">–¢–ï–ö–°–¢ <input type="color" id="fColor" value="#ffffff"></div>
            <div style="flex:1">–†–ê–ú–ö–ê <input type="color" id="gColor" value="#c084fc"></div>
        </div>
    </div>

    <div class="section">
        <h3>2. –ó–∞–¥–∞–Ω–∏—è</h3>
        <input type="text" id="oneQ" placeholder="–ü—Ä–∏–º–µ—Ä (5+5)">
        <input type="text" id="oneA" placeholder="–û—Ç–≤–µ—Ç (10)">
        <button class="btn btn-add" onclick="addSingle()">+ –î–æ–±–∞–≤–∏—Ç—å</button>
        <div style="text-align:center; margin: 8px 0; font-size: 9px; color: #666;">–õ–ò–ë–û –°–ü–ò–°–ö–û–ú (–ü—Ä–∏–º–µ—Ä=–û—Ç–≤–µ—Ç)</div>
        <textarea id="bulkTasks" style="height: 50px;" placeholder="2+2=4&#10;3+3=6"></textarea>
        <button class="btn" style="background:#475569; color:white;" onclick="importBulk()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫</button>
    </div>

    <h3>3. –ü—Ä–∏–≤—è–∑–∫–∞ –∫ –∫–∞—Ä—Ç–∏–Ω–∫–µ</h3>
    <div id="taskList"></div>

    <div class="section" id="areaControls" style="display:none; border: 1px solid var(--primary);">
        <h4 id="activeTaskTitle" style="margin:0 0 8px; font-size:11px; color: var(--primary);"></h4>
        <div style="display:flex; gap:5px;">
            <input type="color" id="taskColor" value="#ff4d6d" style="width:50px; height:38px;">
            <button class="btn" onclick="saveArea()">–°–û–•–†–ê–ù–ò–¢–¨ –û–ë–õ–ê–°–¢–¨</button>
        </div>
        <div class="hint-bar">–ö–ª–∏–∫–∞–π—Ç–µ –ø–æ –∫–∞—Ä—Ç–∏–Ω–∫–µ, —á—Ç–æ–±—ã —Å–æ–∑–¥–∞—Ç—å –∫–æ–Ω—Ç—É—Ä. –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ—Å–∫–æ–ª—å–∫–æ –æ–±–ª–∞—Å—Ç–µ–π –∫ –æ–¥–Ω–æ–π –∑–∞–¥–∞—á–µ.</div>
        <button class="btn" style="background:none; color:#ff4d4d; font-size:10px;" onclick="points=[]; draw();">–°–±—Ä–æ—Å–∏—Ç—å —Ç–æ—á–∫–∏</button>
    </div>

    <div class="section">
        <button class="btn" style="background:var(--accent)" onclick="generateGame()">–°–ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨ –ò–ì–†–£</button>
        <textarea id="finalCode" style="height:35px; font-size:8px; margin-top:5px;" readonly placeholder="–ö–æ–¥ –¥–ª—è Genially..."></textarea>
    </div>
</div>

<div class="canvas-area">
    <div id="preview-box">
        <button onclick="document.getElementById('preview-box').style.display='none'" style="position:absolute; top:15px; right:15px; z-index:2000; background:#ff4d4d; color:white; border:0; padding:12px 25px; border-radius:8px; cursor:pointer;">–ó–ê–ö–†–´–¢–¨</button>
        <iframe id="preview-iframe" style="width:100%; height:100%; border:0;"></iframe>
    </div>
    <div class="frame">
        <img id="mainImg" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7">
        <svg id="mainSvg" viewBox="0 0 1000 1000" preserveAspectRatio="none"></svg>
    </div>
</div>

<script>
    let tasks = [];
    let activeIdx = -1;
    let points = [];
    let currentImgBase64 = "";

    function loadPreset() {
        const url = document.getElementById('imgPreset').value;
        if(!url) return;
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = function() {
            const canvas = document.createElement("canvas");
            canvas.width = img.width; canvas.height = img.height;
            canvas.getContext("2d").drawImage(img, 0, 0);
            currentImgBase64 = canvas.toDataURL("image/png");
            document.getElementById('mainImg').src = currentImgBase64;
        };
        img.src = url;
    }

    document.getElementById('fileInp').onchange = (e) => {
        const r = new FileReader();
        r.onload = (ev) => { currentImgBase64 = ev.target.result; document.getElementById('mainImg').src = currentImgBase64; };
        r.readAsDataURL(e.target.files[0]);
    };

    function addSingle() {
        const q = document.getElementById('oneQ').value;
        const a = document.getElementById('oneA').value;
        if(!q || !a) return;
        tasks.push({ q, a, color: '#ff4d6d', areas: [] });
        document.getElementById('oneQ').value = ''; 
        document.getElementById('oneA').value = '';
        updateList();
    }

    function importBulk() {
        const lines = document.getElementById('bulkTasks').value.split('\n');
        lines.forEach(line => {
            if(line.includes('=')) {
                const [q, a] = line.split('=');
                tasks.push({ q: q.trim(), a: a.trim(), color: '#ff4d6d', areas: [] });
            }
        });
        document.getElementById('bulkTasks').value = '';
        updateList();
    }

    function updateList() {
        const container = document.getElementById('taskList');
        container.innerHTML = tasks.map((t, i) => `
            <div class="task-item ${i === activeIdx ? 'active' : ''}" onclick="selectTask(${i})">
                <span class="badge">${t.areas.length} –æ–±–ª.</span>
                <b>${t.q}</b> = ${t.a}
                <span class="del" onclick="tasks.splice(${i},1); activeIdx=-1; updateList(); draw(); event.stopPropagation();">‚úñ</span>
            </div>
        `).join('');
    }

    function selectTask(i) {
        activeIdx = i;
        points = [];
        document.getElementById('areaControls').style.display = 'block';
        document.getElementById('activeTaskTitle').innerText = "–í—ã–±—Ä–∞–Ω–æ: " + tasks[i].q;
        document.getElementById('taskColor').value = tasks[i].color;
        updateList();
        draw();
    }

    document.getElementById('mainSvg').onclick = (e) => {
        if(activeIdx === -1) return alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É –≤ —Å–ø–∏—Å–∫–µ!");
        const rect = document.getElementById('mainSvg').getBoundingClientRect();
        points.push({ x: ((e.clientX - rect.left) / rect.width) * 1000, y: ((e.clientY - rect.top) / rect.height) * 1000 });
        draw();
    };

    function draw() {
        let h = '';
        if(points.length > 0) {
            h += `<polyline points="${points.map(p=>p.x+','+p.y).join(' ')}" fill="none" stroke="yellow" stroke-width="4" />`;
            points.forEach(p => h += `<circle cx="${p.x}" cy="${p.y}" r="6" fill="red" />`);
        }
        tasks.forEach((t, i) => {
            t.areas.forEach(area => {
                h += `<polygon points="${area.map(p=>p.x+','+p.y).join(' ')}" fill="${t.color}${i===activeIdx?'99':'44'}" stroke="${t.color}" stroke-width="${i===activeIdx?3:1}" />`;
            });
        });
        document.getElementById('mainSvg').innerHTML = h;
    }

    function saveArea() {
        if(points.length < 3) return alert("–ù—É–∂–Ω–æ —Ö–æ—Ç—è –±—ã 3 —Ç–æ—á–∫–∏!");
        tasks[activeIdx].areas.push([...points]);
        tasks[activeIdx].color = document.getElementById('taskColor').value;
        points = [];
        updateList();
        draw();
    }

    function generateGame() {
        if(tasks.length === 0 || !currentImgBase64) return alert("–î–æ–±–∞–≤—å—Ç–µ –∑–∞–¥–∞–Ω–∏—è –∏ –≤—ã–±–µ—Ä–∏—Ç–µ –∫–∞—Ä—Ç–∏–Ω–∫—É!");
        const config = {
            img: currentImgBase64,
            tasks: tasks,
            font: document.getElementById('fontFamily').value,
            textColor: document.getElementById('fColor').value,
            glow: document.getElementById('gColor').value
        };

        const html = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <link href="https://fonts.googleapis.com/css2?family=${config.font.replace(/'/g,'').replace(' ','+')}&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"><\/script>
    <style>
        body { margin: 0; background: transparent; font-family: ${config.font}, sans-serif; height: 100vh; display: grid; grid-template-columns: 35% 65%; overflow: hidden; color: ${config.textColor}; }
        .ui { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; background: rgba(0,0,0,0.4); text-align:center; }
        .card { background: rgba(10, 20, 40, 0.95); padding: 35px; border-radius: 30px; border: 3px solid ${config.glow}; box-shadow: 0 0 30px ${config.glow}55; width: 100%; box-sizing: border-box; }
        .img-side { display: flex; align-items: center; justify-content: center; background: #fff; padding: 20px; }
        .frame { position: relative; line-height: 0; border: 6px solid ${config.glow}; border-radius: 12px; box-shadow: 0 0 40px rgba(0,0,0,0.2); }
        img { max-width: 100%; max-height: 85vh; display: block; }
        svg { position: absolute; top:0; left:0; width:100%; height:100%; }
        input { width: 100%; padding: 15px; margin: 20px 0; border-radius: 15px; border: 2px solid ${config.glow}; background: #000; color: #fff; font-size: 24px; text-align: center; font-family: inherit; }
        .btn { background: ${config.glow}; color: #000; padding: 18px; border-radius: 15px; cursor: pointer; font-weight: bold; border: 0; font-size: 20px; width: 100%; }
        .paint-can { width: 70px; height: 70px; border-radius: 50%; border: 4px solid #fff; margin: 20px auto; display: none; cursor: pointer; animation: pulse 1.2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .num-label { font-size: 24px; font-weight: 900; fill: #111; pointer-events: none; text-shadow: 1px 1px 0 #fff; }
        polygon { transition: 0.3s; cursor: pointer; fill: #fff; stroke: #ddd; }
    </style>
</head>
<body>
    <div class="ui">
        <div class="card" id="gameCard">
            <div id="qText" style="font-size: 38px; min-height: 50px;"></div>
            <input type="text" id="ansInp" placeholder="–û–¢–í–ï–¢...">
            <button class="btn" onclick="check()">–ü–†–û–í–ï–†–ò–¢–¨</button>
            <div id="paintBox" class="paint-can" onclick="pickPaint()"></div>
            <div id="hint" style="margin-top:15px; font-size: 14px;"></div>
        </div>
    </div>
    <div class="img-side"><div class="frame"><img src="${config.img}"><svg id="gameSvg"></svg></div></div>
    <script>
        const tasks = ${JSON.stringify(config.tasks)};
        let curIdx = 0, hasPaint = false, solvedIdxs = [];

        function render() {
            if(curIdx >= tasks.length) {
                document.getElementById('gameCard').innerHTML = "<h1>–ì–û–¢–û–í–û! üéâ</h1><p>–ö–∞—Ä—Ç–∏–Ω–∫–∞ —Ä–∞—Å–∫—Ä–∞—à–µ–Ω–∞!</p>";
                return;
            }
            const q = tasks[curIdx];
            const el = document.getElementById('qText');
            if(q.q.includes('\\\\')) katex.render(q.q, el); else el.textContent = q.q;
            document.getElementById('ansInp').value = '';
            document.getElementById('paintBox').style.display = 'none';
            document.getElementById('hint').textContent = '–†–µ—à–∏—Ç–µ –ø—Ä–∏–º–µ—Ä –∏ –≤–≤–µ–¥–∏—Ç–µ –æ—Ç–≤–µ—Ç';
            hasPaint = false;
            drawSvg();
        }

        window.check = () => {
            const val = document.getElementById('ansInp').value.trim().toLowerCase();
            if(val === tasks[curIdx].a.toLowerCase()) {
                document.getElementById('paintBox').style.display = 'block';
                document.getElementById('paintBox').style.backgroundColor = tasks[curIdx].color;
                document.getElementById('hint').textContent = '–í–µ—Ä–Ω–æ! –ö–ª–∏–∫–Ω–∏ –Ω–∞ –∫—Ä–∞—Å–∫—É, –∑–∞—Ç–µ–º –Ω–∞ —á–∏—Å–ª–æ ' + tasks[curIdx].a;
            } else { alert('–ù–µ–≤–µ—Ä–Ω–æ, –ø–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑!'); }
        };

        window.pickPaint = () => { hasPaint = true; document.getElementById('hint').textContent = '–ö—Ä–∞—Å–∫–∞ –≤–∑—è—Ç–∞! –ù–∞–∂–∏–º–∞–π –Ω–∞ –æ–±–ª–∞—Å—Ç–∏ —Å —á–∏—Å–ª–æ–º ' + tasks[curIdx].a; };

        function drawSvg() {
            const svg = document.getElementById('gameSvg');
            let h = '';
            tasks.forEach((t, tIdx) => {
                const isSolved = solvedIdxs.includes(tIdx);
                t.areas.forEach(pts => {
                    const cx = pts.reduce((a,b)=>a+b.x,0)/pts.length;
                    const cy = pts.reduce((a,b)=>a+b.y,0)/pts.length;
                    h += \`<polygon points="\${pts.map(p=>p.x+','+p.y).join(' ')}" 
                                  fill="\${isSolved ? t.color : '#fff'}" 
                                  onclick="clickArea(\${tIdx})"></polygon>\`;
                    if(!isSolved) {
                        h += \`<text x="\${cx}" y="\${cy}" class="num-label" text-anchor="middle" dominant-baseline="middle">\${t.a}</text>\`;
                    }
                });
            });
            svg.innerHTML = h;
        }

        window.clickArea = (tIdx) => {
            if(hasPaint && tIdx === curIdx) {
                solvedIdxs.push(tIdx);
                curIdx++;
                render();
            }
        };
        render();
    <\/script>
</body>
</html>`;

        const iframe = document.getElementById('preview-iframe');
        iframe.srcdoc = html;
        document.getElementById('preview-box').style.display = 'block';
        document.getElementById('finalCode').value = `<iframe srcdoc="${html.replace(/"/g, '&quot;')}" width="100%" height="600" style="border:0;" allowtransparent="true"></iframe>`;
    }
</script>
</body>
</html>
