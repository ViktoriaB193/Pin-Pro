<!doctype html>
<html lang="ru">
<head>
    <meta charset="utf-8"/>
    <title>–†–ê–°–°–ö–†–ê–°–ö–ê –ü–û –û–¢–í–ï–¢–ê–ú ‚Äî ULTIMATE 6.0</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Comfortaa:wght@700&family=Kelly+Slab&family=Lobster&family=Montserrat:wght@900&family=Pacifico&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"></script>
    <style>
        :root { --bg: #050817; --panel: #0b1126; --text: #f1f5f9; --primary: #c084fc; --accent: #38bdf8; }
        body { margin: 0; font-family: 'Comfortaa', cursive; background: var(--bg); color: var(--text); height: 100vh; display: grid; grid-template-columns: 420px 1fr; overflow: hidden; }
        
        .sidebar { background: var(--panel); border-right: 1px solid #1e293b; display: flex; flex-direction: column; overflow-y: auto; padding: 15px; gap: 10px; }
        .header-main { display: flex; align-items: center; gap: 12px; padding-bottom: 10px; border-bottom: 2px solid var(--primary); }
        .header-main h1 { font-size: 16px; margin: 0; color: #fff; text-transform: uppercase; }

        .section { padding: 12px; background: rgba(255,255,255,0.03); border-radius: 10px; border: 1px solid #1e293b; }
        h3 { margin: 0 0 8px; font-size: 10px; text-transform: uppercase; color: var(--accent); letter-spacing: 1px; }
        
        input, textarea, select { width: 100%; padding: 8px; border-radius: 6px; border: 1px solid #1e293b; background: #161e3d; color: #fff; margin-bottom: 6px; font-family: inherit; box-sizing: border-box; }
        .btn { width: 100%; padding: 10px; border-radius: 6px; border: 0; cursor: pointer; font-weight: bold; background: var(--primary); color: #000; transition: 0.2s; }
        .btn:hover { transform: translateY(-1px); filter: brightness(1.2); }
        .btn-add { background: #22c55e; color: white; }

        /* –°–ø–∏—Å–æ–∫ –∑–∞–¥–∞—á */
        #taskList { flex: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 5px; }
        .task-item { padding: 10px; background: #1e293b; border-radius: 8px; border: 2px solid transparent; cursor: pointer; position: relative; font-size: 13px; }
        .task-item.active { border-color: var(--primary); background: #2d3748; }
        .task-item:hover { background: #252f44; }
        .task-item .badge { float: right; background: var(--accent); color: #000; padding: 2px 6px; border-radius: 10px; font-size: 10px; font-weight: bold; }
        .task-item .del { color: #ff4d4d; margin-left: 10px; float: right; }

        /* –•–æ–ª—Å—Ç */
        .canvas-area { position: relative; background: radial-gradient(circle, #1e293b 0%, #020617 100%); display: flex; justify-content: center; align-items: center; padding: 20px; }
        .frame { position: relative; border: 3px solid var(--primary); border-radius: 8px; background: white; line-height: 0; box-shadow: 0 0 30px rgba(0,0,0,0.5); }
        #mainImg { max-width: 100%; max-height: 70vh; display: block; pointer-events: none; }
        #mainSvg { position: absolute; top: 0; left: 0; width: 100%; height: 100%; cursor: crosshair; }

        #preview-box { position: absolute; inset: 0; background: var(--bg); z-index: 1000; display: none; }
        .hint-bar { font-size: 10px; color: #888; margin-top: 4px; }
    </style>
</head>
<body>

<div class="sidebar">
    <div class="header-main">
        <img src="https://i.ibb.co/q345VSpm/5291888536539828600.jpg" height="35" style="border-radius:50%">
        <h1>ULTIMATE CONSTRUCTOR 6.0</h1>
    </div>

    <div class="section">
        <h3>1. –°—Ç–∏–ª—å –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è</h3>
        <select id="imgPreset" onchange="loadPreset()">
            <option value="">-- –í—ã–±—Ä–∞—Ç—å —à–∞–±–ª–æ–Ω --</option>
            <option value="https://i.ibb.co/jvj9q36b/c8fae767598537c00255e117f9b1199b.jpg">–ú–∏–ª—ã–π –µ–¥–∏–Ω–æ—Ä–æ–≥</option>
            <option value="https://i.ibb.co/GqxzQ5c/2026-02-16-234253.png">–ú—É–¥—Ä–∞—è –°–æ–≤–∞</option>
            <option value="https://i.ibb.co/XZfDj366/2026-02-16-234445.png">–ë–∞—Ä–±–æ—Å–∫–∏–Ω—ã</option>
        </select>
        <input type="file" id="fileInp" accept="image/*">
        <select id="fontFamily">
            <option value="'Comfortaa'">–®—Ä–∏—Ñ—Ç: Comfortaa</option>
            <option value="'Kelly Slab'">–®—Ä–∏—Ñ—Ç: Kelly Slab</option>
            <option value="'Lobster'">–®—Ä–∏—Ñ—Ç: Lobster</option>
            <option value="'Montserrat'">–®—Ä–∏—Ñ—Ç: Montserrat</option>
            <option value="'Pacifico'">–®—Ä–∏—Ñ—Ç: Pacifico</option>
        </select>
        <div style="display:flex; gap:5px;">
            <div style="flex:1">–¢–ï–ö–°–¢ <input type="color" id="fColor" value="#ffffff"></div>
            <div style="flex:1">–†–ê–ú–ö–ê <input type="color" id="gColor" value="#c084fc"></div>
        </div>
    </div>

    <div class="section">
        <h3>2. –î–æ–±–∞–≤–ª–µ–Ω–∏–µ –∑–∞–¥–∞–Ω–∏–π</h3>
        <div id="singleInput">
            <input type="text" id="oneQ" placeholder="–ü—Ä–∏–º–µ—Ä (–Ω–∞–ø—Ä. 5+5)">
            <input type="text" id="oneA" placeholder="–û—Ç–≤–µ—Ç (–Ω–∞–ø—Ä. 10)">
            <button class="btn btn-add" onclick="addSingle()">+ –î–æ–±–∞–≤–∏—Ç—å –≤ —Å–ø–∏—Å–æ–∫</button>
        </div>
        <div style="text-align:center; margin: 8px 0; font-size: 10px; color: var(--accent);">‚Äî –ò–õ–ò ‚Äî</div>
        <textarea id="bulkTasks" style="height: 60px;" placeholder="–ü—Ä–∏–º–µ—Ä1=–û—Ç–≤–µ—Ç1&#10;–ü—Ä–∏–º–µ—Ä2=–û—Ç–≤–µ—Ç2"></textarea>
        <button class="btn" style="background:#475569; color:white;" onclick="importBulk()">–ò–º–ø–æ—Ä—Ç–∏—Ä–æ–≤–∞—Ç—å —Å–ø–∏—Å–æ–∫</button>
    </div>

    <h3>3. –ü—Ä–∏–≤—è–∑–∫–∞ –æ–±–ª–∞—Å—Ç–µ–π</h3>
    <div id="taskList"></div>

    <div class="section" id="areaControls" style="display:none; border: 1px solid var(--primary); background: rgba(192, 132, 252, 0.05);">
        <h4 id="activeTaskTitle" style="margin:0 0 8px; font-size:12px; color: var(--primary);">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: </h4>
        <div style="display:flex; gap:5px;">
            <input type="color" id="taskColor" value="#ff4d6d" style="width:50px; height:38px;">
            <button class="btn" onclick="saveArea()">–ü–†–ò–ö–†–ï–ü–ò–¢–¨ –û–ë–õ–ê–°–¢–¨</button>
        </div>
        <div class="hint-bar">–ö–ª–∏–∫–∞–π—Ç–µ –ø–æ –∫–∞—Ä—Ç–∏–Ω–∫–µ, —á—Ç–æ–±—ã –æ–±–≤–µ—Å—Ç–∏ –¥–µ—Ç–∞–ª—å, –∑–∞—Ç–µ–º –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É –≤—ã—à–µ.</div>
        <button class="btn" style="background:none; color:#ff4d4d; font-size:10px; margin-top:5px;" onclick="points=[]; draw();">–°–±—Ä–æ—Å–∏—Ç—å —Ç–µ–∫—É—â–∏–π –∫–æ–Ω—Ç—É—Ä</button>
    </div>

    <div class="section">
        <button class="btn" style="background:var(--accent)" onclick="generateGame()">–°–ì–ï–ù–ï–†–ò–†–û–í–ê–¢–¨ –ò–ì–†–£</button>
        <textarea id="finalCode" style="height:35px; font-size:8px; margin-top:5px;" readonly placeholder="–ö–æ–¥ –ø–æ—è–≤–∏—Ç—Å—è –∑–¥–µ—Å—å..."></textarea>
    </div>
</div>

<div class="canvas-area">
    <div id="preview-box">
        <button onclick="document.getElementById('preview-box').style.display='none'" style="position:absolute; top:15px; right:15px; z-index:2000; background:#ff4d4d; color:white; border:0; padding:12px 25px; border-radius:8px; cursor:pointer; font-weight:bold;">–ó–ê–ö–†–´–¢–¨ –ü–†–ï–î–ü–†–û–°–ú–û–¢–†</button>
        <iframe id="preview-iframe" style="width:100%; height:100%; border:0;"></iframe>
    </div>

    <div class="frame">
        <img id="mainImg" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" crossorigin="anonymous">
        <svg id="mainSvg" viewBox="0 0 1000 1000" preserveAspectRatio="none"></svg>
    </div>
</div>

<script>
    let tasks = [];
    let activeIdx = -1;
    let points = [];
    let currentImgBase64 = "";

    function loadPreset() {
        const url = document.getElementById('imgPreset').value;
        if(!url) return;
        const img = new Image();
        img.crossOrigin = "anonymous";
        img.onload = function() {
            const canvas = document.createElement("canvas");
            canvas.width = img.width; canvas.height = img.height;
            canvas.getContext("2d").drawImage(img, 0, 0);
            currentImgBase64 = canvas.toDataURL("image/png");
            document.getElementById('mainImg').src = currentImgBase64;
        };
        img.src = url;
    }

    document.getElementById('fileInp').onchange = (e) => {
        const r = new FileReader();
        r.onload = (ev) => { currentImgBase64 = ev.target.result; document.getElementById('mainImg').src = currentImgBase64; };
        r.readAsDataURL(e.target.files[0]);
    };

    function addSingle() {
        const q = document.getElementById('oneQ').value;
        const a = document.getElementById('oneA').value;
        if(!q || !a) return;
        tasks.push({ q, a, color: '#ff4d6d', areas: [] });
        document.getElementById('oneQ').value = ''; document.getElementById('oneA').value = '';
        updateList();
    }

    function importBulk() {
        const lines = document.getElementById('bulkTasks').value.split('\n');
        lines.forEach(line => {
            if(line.includes('=')) {
                const [q, a] = line.split('=');
                tasks.push({ q: q.trim(), a: a.trim(), color: '#ff4d6d', areas: [] });
            }
        });
        document.getElementById('bulkTasks').value = '';
        updateList();
    }

    function updateList() {
        const container = document.getElementById('taskList');
        container.innerHTML = tasks.map((t, i) => `
            <div class="task-item ${i === activeIdx ? 'active' : ''}" onclick="selectTask(${i})">
                <span class="badge">${t.areas.length}</span>
                <b>${t.q}</b> = ${t.a}
                <span class="del" onclick="tasks.splice(${i},1); activeIdx=-1; updateList(); draw(); event.stopPropagation();">‚úñ</span>
            </div>
        `).join('');
    }

    function selectTask(i) {
        activeIdx = i;
        points = [];
        document.getElementById('areaControls').style.display = 'block';
        document.getElementById('activeTaskTitle').innerText = "–ó–∞–¥–∞—á–∞: " + tasks[i].q;
        document.getElementById('taskColor').value = tasks[i].color;
        updateList();
        draw();
    }

    document.getElementById('mainSvg').onclick = (e) => {
        if(activeIdx === -1) return alert("–°–Ω–∞—á–∞–ª–∞ –≤—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É –≤ —Å–ø–∏—Å–∫–µ!");
        const rect = document.getElementById('mainSvg').getBoundingClientRect();
        points.push({ x: ((e.clientX - rect.left) / rect.width) * 1000, y: ((e.clientY - rect.top) / rect.height) * 1000 });
        draw();
    };

    function draw() {
        let h = '';
        if(points.length > 0) {
            h += `<polyline points="${points.map(p=>p.x+','+p.y).join(' ')}" fill="none" stroke="yellow" stroke-width="4" />`;
            points.forEach(p => h += `<circle cx="${p.x}" cy="${p.y}" r="5" fill="red" />`);
        }
        tasks.forEach((t, i) => {
            t.areas.forEach(area => {
                h += `<polygon points="${area.map(p=>p.x+','+p.y).join(' ')}" fill="${t.color}${i===activeIdx?'aa':'55'}" stroke="${t.color}" stroke-width="${i===activeIdx?3:1}" />`;
            });
        });
        document.getElementById('mainSvg').innerHTML = h;
    }

    function saveArea() {
        if(points.length < 3) return alert("–ù—É–∂–Ω–æ —Ö–æ—Ç—è –±—ã 3 —Ç–æ—á–∫–∏!");
        tasks[activeIdx].areas.push([...points]);
        tasks[activeIdx].color = document.getElementById('taskColor').value;
        points = [];
        updateList();
        draw();
    }

    function generateGame() {
        if(tasks.length === 0 || !currentImgBase64) return alert("–ù–∞—Å—Ç—Ä–æ–π—Ç–µ –∑–∞–¥–∞–Ω–∏—è –∏ –∫–∞—Ä—Ç–∏–Ω–∫—É!");
        
        const config = {
            img: currentImgBase64,
            tasks: tasks,
            font: document.getElementById('fontFamily').value,
            textColor: document.getElementById('fColor').value,
            glow: document.getElementById('gColor').value
        };

        const html = `
<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.css">
    <link href="https://fonts.googleapis.com/css2?family=${config.font.replace(/'/g,'').replace(' ','+')}&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/katex@0.16.9/dist/katex.min.js"><\/script>
    <style>
        body { margin: 0; background: transparent; font-family: ${config.font}, sans-serif; height: 100vh; display: grid; grid-template-columns: 38% 62%; overflow: hidden; color: ${config.textColor}; }
        .sidebar { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; text-align: center; background: rgba(0,0,0,0.4); }
        .card { background: rgba(10, 20, 40, 0.9); padding: 40px; border-radius: 30px; border: 3px solid ${config.glow}; box-shadow: 0 0 30px ${config.glow}55; width: 100%; box-sizing: border-box; }
        .img-area { display: flex; align-items: center; justify-content: center; background: white; }
        .frame { position: relative; line-height: 0; box-shadow: 0 0 50px rgba(0,0,0,0.3); border: 5px solid ${config.glow}; border-radius: 10px; overflow: hidden; }
        img { max-width: 100%; max-height: 90vh; display: block; }
        svg { position: absolute; top:0; left:0; width:100%; height:100%; }
        input { width: 100%; padding: 18px; margin: 25px 0; border-radius: 15px; border: 2px solid ${config.glow}; background: #000; color: #fff; font-size: 28px; text-align: center; font-family: inherit; }
        .btn { background: ${config.glow}; color: #000; padding: 18px; border-radius: 15px; cursor: pointer; font-weight: bold; border: 0; font-size: 22px; width: 100%; }
        .paint-can { width: 80px; height: 80px; border-radius: 50%; border: 4px solid #fff; margin: 20px auto; display: none; cursor: pointer; animation: pulse 1.5s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }
        .num-label { font-size: 26px; font-weight: 900; fill: #222; cursor: pointer; pointer-events: all; text-shadow: 1px 1px 0 #fff; }
        polygon { transition: 0.3s; cursor: pointer; }
        polygon:hover { opacity: 0.8; }
    </style>
</head>
<body>
    <div class="sidebar">
        <div class="card" id="gameCard">
            <div id="qText" style="font-size: 40px; margin-bottom: 15px;"></div>
            <input type="text" id="ansInp" placeholder="–û–¢–í–ï–¢...">
            <button class="btn" onclick="check()">–ü–†–û–í–ï–†–ò–¢–¨</button>
            <div id="paintBox" class="paint-can" onclick="pickPaint()"></div>
            <div id="hint" style="margin-top:20px; font-size: 16px; opacity: 0.9;"></div>
        </div>
    </div>
    <div class="img-area">
        <div class="frame">
            <img src="${config.img}">
            <svg id="gameSvg"></svg>
        </div>
    </div>
    <script>
        const tasks = ${JSON.stringify(config.tasks)};
        let curIdx = 0, canPaint = false, solved = [];

        function init() {
            if(curIdx >= tasks.length) { 
                document.getElementById('gameCard').innerHTML = "<h1 style='font-size:50px'>–ë–†–ê–í–û! üéâ</h1><p>–ö–∞—Ä—Ç–∏–Ω–∫–∞ –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–∞—Å–∫—Ä–∞—à–µ–Ω–∞!</p>"; 
                return; 
            }
            const q = tasks[curIdx];
            const el = document.getElementById('qText');
            if(q.q.includes('\\\\')) katex.render(q.q, el); else el.textContent = q.q;
            document.getElementById('ansInp').value = '';
            document.getElementById('paintBox').style.display = 'none';
            document.getElementById('hint').textContent = '';
            canPaint = false;
            draw();
        }

        window.check = () => {
            const val = document.getElementById('ansInp').value.trim().toLowerCase();
            if(val === tasks[curIdx].a.toLowerCase()) {
                document.getElementById('paintBox').style.display = 'block';
                document.getElementById('paintBox').style.backgroundColor = tasks[curIdx].color;
                document.getElementById('hint').innerHTML = "<b>–í–ï–†–ù–û!</b><br>–ù–∞–∂–º–∏ –Ω–∞ –∫—Ä–∞—Å–∫—É –∏ –∫–ª–∏–∫–Ω–∏ –Ω–∞ —á–∏—Å–ª–æ " + tasks[curIdx].a;
            } else { alert('–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ, –ø–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑!'); }
        };

        window.pickPaint = () => { 
            canPaint = true; 
            document.getElementById('hint').textContent = "–ö—Ä–∞—Å–∫–∞ –≤–∑—è—Ç–∞! –†–∞—Å–∫—Ä–∞—à–∏–≤–∞–π –æ–±–ª–∞—Å—Ç–∏ —Å —á–∏—Å–ª–æ–º " + tasks[curIdx].a; 
        };

        function draw() {
            const svg = document.getElementById('gameSvg');
            svg.innerHTML = tasks.map((t, tIdx) => {
                const isSolved = solved.includes(tIdx);
                return t.areas.map(area => {
                    const cx = area.reduce((s,p)=>s+p.x,0)/area.length;
                    const cy = area.reduce((s,p)=>s+p.y,0)/area.length;
                    return \`
                        <polygon points="\${area.map(p=>p.x+','+p.y).join(' ')}" fill="\${isSolved ? t.color : '#ffffff'}" stroke="#ddd" onclick="doClick(\${tIdx})" />
                        \${!isSolved ? \`<text x="\${cx}" y="\${cy}" class="num-label" text-anchor="middle" dominant-baseline="middle" onclick="doClick(\${tIdx})">\${t.a}</text>\` : ''}
                    \`;
                }).join('');
            }).join('');
        }

        window.doClick = (idx) => {
            if(canPaint && idx === curIdx) {
                solved.push(curIdx);
                curIdx++;
                init();
            }
        };
        init();
    <\/script>
</body>
</html>`;

        const iframe = document.getElementById('preview-iframe');
        iframe.srcdoc = html;
        document.getElementById('preview-box').style.display = 'block';
        document.getElementById('finalCode').value = `<iframe srcdoc="${html.replace(/"/g, '&quot;')}" width="100%" height="600" style="border:0;" allowtransparent="true"></iframe>`;
    }
</script>
</body>
</html>
